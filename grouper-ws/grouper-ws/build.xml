<project name="grouper-ws" default="dist" basedir=".">
	<!-- sets DSTAMP etc -->
	<tstamp/>
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${basedir}/lib/ant/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<!-- 
	provides all environment variables as Ant properties prefixed by "env.". 
	For example, CLASSPATH would be accessible in Ant as ${env.CLASSPATH}. 
	-->
	<property environment="env" />
	<available file="build.properties" property="build.properties.exists" value="true"/>
	
  <fail message="Couldnt detect build.properties file, copy the build.example.properties to build.properties in the project base dir, and customize" unless="build.properties.exists" />
	<property file="build.properties" />

	<!-- validate the build.properties -->
	<fail message="Couldnt detect build.properties property file entry: webapp.folder" unless="webapp.folder" />
	<fail message="Couldnt detect build.properties property file entry: dist.cleanOnDist" unless="dist.cleanOnDist" />
	<fail message="Couldnt detect build.properties property file entry: dist.packageAar" unless="dist.packageAar" />
	<fail message="Couldnt detect build.properties property file entry: dist.generateWsdlOnDist" unless="dist.generateWsdlOnDist" />
	<fail message="Couldnt detect build.properties property file entry: dist.generateClientOnDist" unless="dist.generateClientOnDist" />
	<fail message="Couldnt detect build.properties property file entry: deploy.context.path" unless="deploy.context.path" />
	<fail message="Couldnt detect build.properties property file entry: generated.client.project.dir" unless="generated.client.project.dir" />
	<fail message="Couldnt detect build.properties property file entry: grouper.dir" unless="grouper.dir" />
  <fail message="Couldnt detect build.properties property file entry: grouper.dist.dir" unless="grouper.dist.dir" />
  <fail message="Couldnt detect build.properties property file entry: stop.tomcat.on.quick.or.dist" unless="stop.tomcat.on.quick.or.dist" />
  <fail message="Couldnt detect build.properties property file entry: tomcat.dir" unless="tomcat.dir" />
  <fail message="Couldnt detect build.properties property file entry: tomcat.port" unless="tomcat.port" />
	
	<property name="webapp.folder" value="${dist.home}/${webapp.name}" />

	<property name="build.dir" value="${basedir}/build" />
	<property name="build.dir.grouper-ws" value="${build.dir}/grouper-ws" />

	<mkdir dir="${build.dir}" />
	<mkdir dir="${build.dir.grouper-ws}" />
	<mkdir dir="${dist.home}" />
	<mkdir dir="${webapp.folder}" />

	<path id="ws.class.path">
		<!-- Make available jar files that Grouper needs -->
		<fileset dir="${basedir}/lib">
			<include name="**/*.jar" />
		</fileset>

		<!-- make available any classes / resources already placed in the build folder -->
		<pathelement location="${build.dir.grouper-ws}" />
	</path>

	<!-- TODO move this out of project -->
	<property name="webservice.folder" value="${webapp.folder}/../webservices" />
	<!-- this didnt work out -->
	<!-- target name="generate.wsdl" >  
    	<mkdir dir="${webservice.folder}"/>
    	<mkdir dir="${webservice.folder}/classes"/>
        <taskdef name="java2wsdl"
                 classname="org.apache.ws.java2wsdl.Java2WSDLTask"
                 classpathref="ws.class.path"/>
        <java2wsdl className="edu.internet2.middleware.grouper.webservices.GrouperService"
                   outputLocation="${wsdl.location}"
                   targetNamespace="http://grouper.internet2.edu/"
                   schemaTargetNamespace="http://grouper.internet2.edu/xsd" -->
	<!-- classpath>
                <pathelement id="ws.class.path"/ -->
	<!--  path="${axis2.classpath} -->
	<!-- pathelement location="${build.dir.grouper-ws}"/>
            </classpath -->
	<!-- /java2wsdl>
    </target -->
	<!-- here are the available options (run with no args to see them)
	     [java] Usage: java2wsdl [options] -cn <fully qualified class name>
     [java] where [options] include:
     [java]   -o <output location>                    output directory
     [java]   -of <output file name>                  output file name for the WSDL
     [java]   -sn <service name>                      service name
     [java]   -l <soap address>                       address of the port for the WSDL
     [java]   -cp <class path uri>                    list of classpath entries - (urls)
     [java]   -tn <target namespace>                  target namespace for service
     [java]   -tp <target namespace prefix>           target namespace prefix for service
     [java]   -stn <schema target namespace>          target namespace for schema
     [java]   -stp <schema target namespace prefix>   target namespace prefix for schema
     [java]   -st <binding style>                     style for the WSDL
     [java]   -u <binding use>                        use for the WSDL
     [java]   -nsg <class name>                       fully qualified name of a class that implements NamespaceGenerator
     [java]   -sg <class name>                        fully qualified name of a class that implements SchemaGenerator
     [java]   -p2n [<java package>,<namespace] [<java package>,<namespace]... 
     [java]                                           java package to namespace mapping for argument and return types
     [java]   -p2n [all, <namespace>]                 to assign all types to a single namespace
     [java]   -efd <qualified/unqualified>            setting for elementFormDefault (defaults to qualified)
     [java]   -afd <qualified/unqualified>            setting for attributeFormDefault (defaults to qualified)
     [java]   -xc class1 -xc class2...                extra class(es) for which schematype must be generated.  
     [java]   -wv <1.1/2.0>                           wsdl version - defaults to 1.1 if not specified
     [java]   -dlb                                    generate schemas conforming to doc/lit/bare style
     -->
	<target name="java2wsdl" description="convert the java to a wsdl">
		<touch file="${generated.client.project.dir}/GrouperService.wsdl" />
		<delete file="${generated.client.project.dir}/GrouperService.wsdl" />
		<java classname="org.apache.ws.java2wsdl.Java2WSDL" fork="true">
			<classpath refid="ws.class.path" />
			<arg value="-o" />
			<arg value="${generated.client.project.dir}" />
			<arg value="-of" />
			<arg value="GrouperService.wsdl" />
			<arg value="-cn" />
			<arg value="edu.internet2.middleware.grouper.webservices.GrouperService" />
			<arg value="-stn" />
			<arg value="http://webservices.grouper.middleware.internet2.edu/xsd" />
			<arg value="-l" />
			<arg value="http://localhost:8090/grouper-ws/services/GrouperService" />

		</java>
	</target>
	<target name="wsdl2java" description="convert the wsdl to a java client">
		<delete>
			<fileset dir="${generated.client.project.dir}">
				<include name="src/edu/internet2/middleware/grouper/webservicesClient/GrouperServiceCallbackHandler.java" />
				<include name="src/edu/internet2/middleware/grouper/webservicesClient/GrouperServiceStub.java" />
				<include name="test/edu/internet2/middleware/grouper/webservicesClient/GrouperServiceTest.java" />
			</fileset>
		</delete>
		<java classname="org.apache.axis2.wsdl.WSDL2Java" fork="true">
			<classpath refid="ws.class.path" />
			<arg value="-uri" />
			<arg file="${generated.client.project.dir}/GrouperService.wsdl" />
			<arg value="-t" />
			<arg value="-p" />
			<arg value="edu.internet2.middleware.grouper.webservicesClient" />
			<arg value="-o" />
			<arg value="${generated.client.project.dir}" />
		</java>

	</target>

	<target name="generate-aar" depends="compile">
		<property name="webservice.folder" value="${basedir}/webservices" />
		<mkdir dir="${webservice.folder}/classes" />
		<delete dir="${webservice.folder}/classes" />
		<mkdir dir="${webservice.folder}/classes" />
		<copy toDir="${webservice.folder}/classes" failonerror="false">
			<fileset dir="${build.dir.grouper-ws}">
				<include name="edu/internet2/middleware/grouper/webservices/**/*.class" />
			</fileset>
		</copy>
		<jar destfile="${basedir}/webapp/WEB-INF/services/GrouperService.aar">
			<fileset excludes="edu/internet2/middleware/grouper/webservices/**/*Test.class" dir="${webservice.folder}/classes" />
			<fileset dir="webservices/GrouperService.aar" />
		</jar>
		<!-- copy the aar to the build dir -->
		<!-- copy file="webapp/WEB-INF/services/GrouperService.aar" 
			todir="../dist/grouper/WEB-INF/services" / -->

	</target>

	<!-- 
	
	Generate the axis bundle based on axis jars
	
	jars that are part of axis which are not in the axis jar:
	
	- activation.jar
	- commons-codec
	- commons-fileupload
	- commons-httpclient
	- commons-io
	- commons-logging
	- jaxb-api
	- jaxb-impl
	- jaxb-xjc
	- log4j
	- mail
	- xalan
	- xercesImpl
	- xml-api
	- XmlSchema
	
	#######################
	jars that are part of axis which we were already using:
	
	- activation (i2mi-common)
	- commons-fileupload (grouper-ui, removed since older)
	- commons-logging (i2mi-common, same file)
	- jaxb-api (i2mi-common, different, common is bigger)
	- jaxb-impl (i2mi-common, different, common is bigger)
	- jaxb-xjc (i2mi-common, different, common is bigger)
	- log4j (grouper, removed since older)
	- xalan (grouper-ui, removed since older)
	- xercesImpl (grouper-ui, removed since older)
	- xml-apis (grouper-ui, removed since older)
	-->
	<target name="generate-axis-bundle-jar">
		<mkdir dir="build/axisLibTemp" />
		<delete dir="build/axisLibTemp" />
		<mkdir dir="build/axisLibTemp" />
		<unzip dest="build/axisLibTemp">
			<fileset dir="lib/axis-bundle" includes="*.jar" />
		</unzip>
		<delete file="lib/axis/axisBundle.jar" />
		<jar destfile="lib/axis/axisBundle.jar" basedir="build/axisLibTemp" />
	</target>

	<target name="clean">
		<mkdir dir="${build.dir}" />
		<delete dir="${build.dir}" />
		<mkdir dir="${build.dir.grouper-ws}" />
	</target>

	<!-- ## End From axis
	############################################### -->
	<target name="compile">
		<javac srcdir="${basedir}/src/grouper-ws" destdir="${build.dir.grouper-ws}" classpathref="ws.class.path" debug="true">
			<compilerarg value="-Xlint:deprecation" />
		</javac>
	</target>
	<!-- 
    Builds the entire webapp 
  -->
	<target name="dist" description="do everything">
		<property name="skipWsdl" value="false" />
		<antcall target="distHelper" />
	</target>
	<!-- 
    Builds the entire webapp 
  -->
	<target name="quick" description="dist, but without wsdl">
		<property name="skipWsdl" value="true" />
		<antcall target="distHelper" />
	</target>
	<!-- 
		Builds the entire webapp, or skips the web service wsdl part
	-->
	<target name="distHelper">

		<!-- TODO put in options to do the log4j and other properties files -->

		<!-- stop tomcat if supposed to -->
		<if>
	    <istrue value="${stop.tomcat.on.quick.or.dist}" />
      <then>
			  <antcall target="tomcatStop" />
			</then>
		</if>
		
		
		<!-- see if we should clean -->
		<if>
			<istrue value="${dist.cleanOnDist}" />
			<then>
				<antcall target="clean" />
			</then>
		</if>

		<if>
			<istrue value="${dist.packageAar}" />
			<then>
				<!-- this will compile -->
				<antcall target="generate-aar" />
			</then>
			<else>
				<!-- make sure things are compiled -->
				<antcall target="compile" />
			</else>
		</if>

		<if>
			<and>
				<istrue value="${dist.generateWsdlOnDist}" />
				<isfalse value="${skipWsdl}" />
			</and>
			<then>
				<antcall target="java2wsdl" />
			</then>
		</if>
		<if>
			<and>
				<istrue value="${dist.generateClientOnDist}" />
				<isfalse value="${skipWsdl}" />
			</and>
			<then>
				<antcall target="wsdl2java" />
			</then>
		</if>

		<!-- make the jar first and include source -->
		<delete file="${dist.home}/grouper-ws.jar" />
		<jar file="${dist.home}/grouper-ws.jar">
			<fileset dir="${build.dir.grouper-ws}" />
			<fileset dir="${basedir}/src/grouper-ws" />
		</jar>

		<mkdir dir="${webapp.folder}/WEB-INF/classes" />
		<mkdir dir="${webapp.folder}/WEB-INF/lib" />

		<!-- Make all necessary jar files available to the webapp itself -->
		<!-- we are doing the classes and source with a jar -->
		<copy todir="${webapp.folder}/WEB-INF/classes">
			<fileset dir="${basedir}/resources" />
		</copy>
		<copy todir="${webapp.folder}/WEB-INF/lib">
			<fileset dir="${basedir}/lib/axis" includes="*.jar" />
			<fileset dir="${basedir}/lib/grouper" includes="*.jar" />
			<fileset dir="${basedir}/lib/grouper-ws" includes="*.jar" />
			<fileset dir="${dist.home}" includes="grouper-ws.jar" />
		</copy>

		<!-- all the webapp axis stuff like services dir and conf dir -->
		<copy todir="${webapp.folder}">
			<fileset dir="${basedir}/webapp" />
		</copy>

		<!-- make a war file -->
		<property name="webapp.war" value="${webapp.folder}.war" />
		<delete file="${webapp.war}" />
		<jar destfile="${webapp.war}">
			<fileset dir="${webapp.folder}" />
		</jar>

	</target>



	<target name="help" description="targets and their description">
		<echo>Please ensure you have read the documentation - </echo>
		<echo>and created a build.properties file based on the template provided</echo>

		<echo>
		</echo>
		<echo>The following targets are available - type the appropriate name:</echo>
		<echo>
		</echo>
		<echo>1) default (dist) </echo>
		<echo>     Simply builds, without cleaning, to the webapp.folder</echo>
		<echo>1) quick </echo>
		<echo>     Simply builds, without cleaning, to the webapp.folder, and skips wsdl parts</echo>
		<echo>2) clean</echo>
		<echo>     Clean the webapp folder, and classfiles, and build</echo>
		<echo>3) generate-aar</echo>
		<echo>     Make the axis archive, which is the classfiles and services.xml that axis needs.  You need to do this if you ever change anything that changes the wsdl.  You can do this automatically in dist by setting a property in the build.properties</echo>
		<echo>4) generate-axis-bundle-jar</echo>
		<echo>     Take all the bundlable axis jars (in lib/axis-bundle), unjar, and jar back up into one jar </echo>
		<echo>5) javadoc</echo>
		<echo>     Generate javadoc to the doc/api dir</echo>
		<echo>6) help</echo>
		<echo>     This message</echo>
    <echo>7) grouper</echo>
    <echo>     Build the grouper jar from build.properties</echo>
		<echo>
		</echo>
	</target>
	<target name="grouper" description="build the grouper jar and copy to the lib dir">
    <ant dir="${grouper.dir}" inheritall="false" target="dist" />
		<!-- now the grouper jar is in   -->
		<!-- copy it to ws, and rename -->
		<copy file="${grouper.dist.dir}/lib/grouper-${DSTAMP}.jar" 
	     tofile="${basedir}/lib/grouper/grouper.jar" failonerror="true"/>
	</target>
	<target name="javadoc" description="generate public api docs to doc/api">
		<!-- Let's be sure we clear out old cruft first... -->
		<mkdir dir="doc/api" />
		<delete dir="doc/api" />
		<mkdir dir="doc/api" />
		<javadoc destdir="doc/api" classpathref="ws.class.path" access="public">
			<packageset dir="src/grouper-ws" defaultexcludes="yes">
				<include name="edu/internet2/middleware/grouper/**" />

			</packageset>

			<link href="http://struts.apache.org/1.2.x/api/" />
			<link href="http://java.sun.com/j2ee/sdk_1.3/techdocs/api" />
			<link href="http://java.sun.com/j2se/1.4.2/docs/api" />

		</javadoc>
	</target>

  <target name="tomcatStop">
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}" />
      <then>
        <!-- stop the tomcat server -->
        <exec dir="${tomcat.dir}" executable="cmd ">
          <arg line="/c ${tomcat.dir}\bin\catalina.bat stop" />
        </exec>
        <!-- give it a sec to release resources -->
      	<antcall target="tomcatWaitFor" />
      </then>
    </if>
  </target>

	<target name="tomcatWaitFor">
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}"  />
      <then>
        <sleep seconds="3" />
      </then>
    </if>
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}" />
      <then>
        <sleep seconds="3" />
      </then>
    </if>
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}" />
      <then>
        <sleep seconds="3" />
      </then>
    </if>
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}" />
      <then>
        <sleep seconds="3" />
      </then>
    </if>
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}" />
      <then>
        <sleep seconds="3" />
      </then>
    </if>
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}" />
      <then>
        <sleep seconds="3" />
      </then>
    </if>
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}" />
      <then>
        <sleep seconds="3" />
      </then>
    </if>
    <if>
      <!-- make sure listening on the debug port -->
      <socket server="localhost" port="${tomcat.port}" />
      <then>
        <sleep seconds="3" />
      </then>
    </if>
	</target>
	
</project>
